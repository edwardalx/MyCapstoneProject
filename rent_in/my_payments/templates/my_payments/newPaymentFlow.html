{% extends "accounts/new_base.html" %}
{% block content %}
<section>
  <h2>Make a Payment</h2>

  <label for="property">Select Property:</label><br>
  <select id="property" required>
    <option value="">-- Select Property --</option>
    {% for property in properties %}
      <option value="{{ property.id }}">{{ property.name }}</option>
    {% endfor %}
  </select><br><br>

  <label for="unit">Select Room:</label><br>
  <select id="unit" disabled required>
    <option value="">-- Select Room --</option>
  </select><br><br>

  <form id="paymentForm" style="display:none;">
    {% csrf_token %}
    <input type="hidden" id="tenant_id" value="{{ user.id }}">
    <input type="hidden" id="unit_id">

    <label>Email:</label><br>
    <input type="email" id="email" value="{{ user.email }}" required><br><br>

    <label>Phone Number:</label><br>
    <input type="text" id="phone" value="{{ user.phoneNo }}" required><br><br>

    <label>Amount (GHS):</label><br>
    <input type="number" id="amount" readonly><br><br>

    <label>Provider:</label><br>
    <select id="provider" required>
      <option value="mtn">MTN</option>
      <option value="vodafone">Vodafone</option>
      <option value="airteltigo">AirtelTigo</option>
    </select><br><br>

    <button type="button" onclick="payWithPaystack()">Pay Now</button>
  </form>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
document.getElementById('property').addEventListener('change', function () {
  const propertyId = this.value;
  const unitSelect = document.getElementById('unit');
  unitSelect.innerHTML = '<option value="">Loading...</option>';
  unitSelect.disabled = true;

  fetch(`/api/properties/${propertyId}/units/`)
    .then(res => res.json())
    .then(data => {
      unitSelect.innerHTML = '<option value="">-- Select Room --</option>';
      data.forEach(unit => {
        unitSelect.innerHTML += `<option value="${unit.id}" data-cost="${unit.cost}">${unit.room_No}</option>`;
      });
      unitSelect.disabled = false;
    });
});

document.getElementById('unit').addEventListener('change', function () {
  const selected = this.selectedOptions[0];
  const cost = selected.getAttribute('data-cost');
  document.getElementById('amount').value = cost;
  document.getElementById('unit_id').value = selected.value;
  document.getElementById('paymentForm').style.display = 'block';
});

function payWithPaystack() {
  const email = document.getElementById('email').value;
  const phone = document.getElementById('phone').value;
  const amount = parseFloat(document.getElementById('amount').value) * 100;
  const provider = document.getElementById('provider').value;
  const tenant_id = document.getElementById('tenant_id').value;
  const unit_id = document.getElementById('unit_id').value;

  fetch("/payments/api/initialize/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, phone, amount, provider, tenant_id, unit_id })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status && data.data.reference) {
      let handler = PaystackPop.setup({
        key: '{{ PAYSTACK_PUBLIC_KEY }}',
        email,
        amount,
        currency: 'GHS',
        ref: data.data.reference,
        metadata: { phone, tenant_id, unit_id },
        callback: function (response) {
          fetch(`/payments/api/verify/${response.reference}/`)
            .then(res => res.json())
            .then(result => {
              alert("Payment " + result.message);
              location.reload();
            });
        },
        onClose: function () {
          alert("Transaction cancelled");
        }
      });
      handler.openIframe();
    } else {
      alert("Failed to initialize payment");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Error processing payment");
  });
}
</script>
{% endblock %}
